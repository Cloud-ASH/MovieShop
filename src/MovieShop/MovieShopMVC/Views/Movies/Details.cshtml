@model ApplicationCore.Models.MovieDetailsModel

@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-4">
            <img src="@Model.PosterUrl" alt="@Model.Title" class="img-fluid rounded" />
        </div>

        <div class="col-md-4">
            <h1>@Model.Title</h1>

            <p>
                <strong>Genre:</strong>
                @foreach (var genre in Model.Genres)
                {
                    <span class="me-2">@genre.Name</span>
                }
            </p>

            <p class="mt-3">
                <strong>Ratings:</strong>
                @foreach (var review in Model.Reviews ?? Enumerable.Empty<ApplicationCore.Entities.Review>())
                {
                    <span class="badge bg-secondary">@review.Rating</span>
                }
            </p>

            <p class="mt-3">
                <strong>Overview:</strong>
                @Model.Overview
            </p>
        </div>

        <div class="col-md-4 d-flex flex-column">
            @{
                var userId = Context.Session.GetString("UserId");
                var isLoggedIn = !string.IsNullOrEmpty(userId);
            }

            @if (isLoggedIn)
            {
                @if (Model.IsPurchased)
                {
                    <button type="button" class="btn btn-outline-success mb-3 w-75 rounded-pill" disabled>
                        <i class="bi bi-check-circle-fill me-2"></i>Already Owned
                    </button>
                    <a href="#" class="btn btn-info mb-3 w-75 rounded-pill text-white">
                        <i class="bi bi-play-circle me-2"></i>Watch Now
                    </a>
                }
                else
                {
                    <button type="button" class="btn btn-warning mb-3 w-75 rounded-pill fw-bold" data-bs-toggle="modal"
                        data-bs-target="#buyMovieModal">
                        <i class="bi bi-cart-plus me-2"></i>Purchase Movie
                    </button>
                }

                <button type="button" class="btn btn-outline-primary mb-3 w-75 rounded-pill" data-bs-toggle="modal"
                    data-bs-target="#leaveReviewModal">
                    <i class="bi bi-pencil-square me-2"></i>Leave a Review
                </button>

                <form asp-controller="Account" asp-action="ToggleFavorite" asp-route-id="@Model.Id" method="post" class="d-grid">
                    <button type="submit" class="btn @(Model.IsFavorite ? "btn-danger rounded-pill" : "btn-outline-secondary rounded-pill") w-75 fw-semibold">
                        <i class="bi @(Model.IsFavorite ? "bi-heart-fill" : "bi-heart") me-2"></i>@(Model.IsFavorite ? "Remove Favorite" : "Add to Favorites")
                    </button>
                </form>
            }
            else
            {
                <a asp-controller="User" asp-action="Login" class="btn btn-outline-warning mb-3 w-75 rounded-pill fw-bold">
                    <i class="bi bi-lock me-2"></i>Login to Purchase
                </a>

                <a asp-controller="User" asp-action="Login" class="btn btn-outline-secondary mb-3 w-75 rounded-pill">
                    <i class="bi bi-pencil me-2"></i>Login to Review
                </a>

                <a asp-controller="User" asp-action="Login" class="btn btn-outline-secondary w-75 rounded-pill">
                    <i class="bi bi-heart me-2"></i>Login to Favorite
                </a>
            }

        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <h3 class="mb-3 mt-2">Movie Facts</h3>

            <ul class="list-group shadow-sm">

                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cash-stack me-2 text-success"></i>Revenue:</span>
                    <strong>@Model.Revenue?.ToString("C0")</strong>
                </li>

                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-translate me-2 text-primary"></i>Language:</span>
                    <strong>@Model.OriginalLanguage?.ToUpper()</strong>
                </li>

                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-event me-2 text-danger"></i>Release Date:</span>
                    <strong>@Model.ReleaseDate?.ToString("yyyy-MM-dd")</strong>
                </li>

            </ul>

            <div class="mt-4">
                <h3 class="mb-3">Trailers</h3>

                <ul class="list-group shadow-sm">

                    @if (Model.Trailers != null && Model.Trailers.Any())
                    {
                        @foreach (var trailer in Model.Trailers)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-play-circle-fill text-danger me-2"></i>
                                    @trailer.Name
                                </div>

                                <a href="@trailer.TrailerUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                    Watch
                                </a>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">
                            No trailers available.
                        </li>
                    }
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <h3 class="mb-3 mt-2">Cast</h3>

            <div class="list-group shadow-sm">

                @if (Model.Casts != null && Model.Casts.Any())
                {
                    @foreach (var cast in Model.Casts)
                    {
                        <a asp-controller="Cast" asp-action="Details" asp-route-id="@cast.Id"
                            class="list-group-item list-group-item-action d-flex align-items-center">

                            <!-- Thumbnail -->
                            <img src="@cast.ProfilePath" alt="@cast.Name" class="rounded-circle me-3"
                                style="width: 45px; height: 45px; object-fit: cover;" />

                            <!-- Name -->
                            <span class="small fw-semibold">
                                @cast.Name
                            </span>

                        </a>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">
                        No cast information available.
                    </div>
                }

            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-3">
                <i class="bi bi-chat-quote text-primary me-2"></i>User Reviews
            </h3>

            @if (Model.Reviews != null && Model.Reviews.Any())
            {
                <div class="list-group shadow-sm">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1 fw-bold">User #@review.UserId</h6>
                                    <small class="text-muted">@review.CreatedDate.ToString("MMM dd, yyyy")</small>
                                </div>
                                <span class="badge bg-warning text-dark">
                                    ‚≠ê @review.Rating.ToString("0.0")/10
                                </span>
                            </div>
                            <p class="mb-0">@review.ReviewText</p>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>No reviews yet. Be the first to review this movie!
                </div>
            }
        </div>
    </div>
</div>

<!-- Buy Movie Modal -->
<div class="modal fade" id="buyMovieModal" tabindex="-1" aria-labelledby="buyMovieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyMovieModalLabel">Purchase Movie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="@Model.PosterUrl" alt="@Model.Title" class="img-fluid mb-3" style="max-height: 200px;" />
                <h4>@Model.Title</h4>
                <p class="text-muted">@Model.Tagline</p>
                <h3 class="text-success">@Model.Price?.ToString("C")</h3>
                <p>Are you sure you want to purchase this movie?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <form asp-controller="Account" asp-action="PurchaseMovie" asp-route-id="@Model.Id" method="post" class="d-inline">
                    <button type="submit" class="btn btn-warning rounded-pill fw-bold">
                        <i class="bi bi-credit-card me-1"></i>Confirm Purchase
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="leaveReviewModal" tabindex="-1" aria-labelledby="leaveReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leaveReviewModalLabel">Write a Review for @Model.Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Movies" asp-action="SubmitReview" asp-route-id="@Model.Id" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <select class="form-select" id="rating" name="rating" required>
                            <option value="">Select a rating...</option>
                            <option value="1">1 - Terrible</option>
                            <option value="2">2 - Poor</option>
                            <option value="3">3 - Bad</option>
                            <option value="4">4 - Below Average</option>
                            <option value="5">5 - Average</option>
                            <option value="6">6 - Above Average</option>
                            <option value="7">7 - Good</option>
                            <option value="8">8 - Very Good</option>
                            <option value="9">9 - Excellent</option>
                            <option value="10">10 - Masterpiece</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reviewText" class="form-label">Your Review</label>
                        <textarea class="form-control" id="reviewText" name="reviewText" rows="5" placeholder="Share your thoughts about this movie..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary rounded-pill">
                        <i class="bi bi-send me-1"></i>Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<partial name="_BuyMovieModal" model="Model" />
<partial name="_LeaveReviewModal" model="Model" />